<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bunny Island: IO Online</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Nunito', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;900&display=swap');

        /* UI STYLES */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        #season-indicator { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.2); padding: 5px 20px; border-radius: 20px; color: white; font-weight: 900; font-size: 1.2rem; backdrop-filter: blur(4px); border: 2px solid rgba(255,255,255,0.4); }
        .score-board { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.95); padding: 8px 25px; border-radius: 50px; font-weight: 900; font-size: 1.6rem; color: #333; display: flex; align-items: center; gap: 15px; border-left: 8px solid #FF9F43; }
        .leaderboard { position: absolute; top: 70px; right: 20px; background: rgba(255,255,255,0.6); padding: 12px; border-radius: 15px; width: 200px; backdrop-filter: blur(4px); }
        .leaderboard ul { list-style: none; padding: 0; margin: 0; font-size: 0.85rem; font-weight: 800; color: #333; }
        .leaderboard li { display: flex; justify-content: space-between; margin-bottom: 4px; }
        
        /* CONTROLS */
        .controls { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #joystick-area { position: absolute; bottom: 40px; left: 40px; width: 130px; height: 130px; background: rgba(255,255,255,0.25); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.5); }
        #joystick-thumb { width: 60px; height: 60px; background: #fff; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #run-btn { position: absolute; bottom: 40px; right: 40px; width: 100px; height: 100px; background: linear-gradient(135deg, #00c6fb, #005bea); border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; border: 5px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        
        /* MENU */
        #menu { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.4) 80%); display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: auto; z-index: 99; backdrop-filter: blur(5px); }
        h1 { font-size: 5rem; color: #fff; margin: 0; line-height: 0.85; text-shadow: 0 10px 20px rgba(0,0,0,0.2); transform: rotate(-3deg); }
        h1 span { color: #FFA502; }
        input[type="text"] { background: rgba(0,0,0,0.4); border: 2px solid rgba(255,255,255,0.3); padding: 15px; border-radius: 30px; color: white; font-size: 1.2rem; text-align: center; margin-top: 30px; outline: none; font-weight: bold; }
        .tap-text { margin-top: 30px; background: white; color: #333; padding: 15px 40px; border-radius: 30px; font-weight: 900; cursor: pointer; font-size: 1.5rem; box-shadow: 0 10px 20px rgba(0,0,0,0.2); transition: transform 0.1s; }
        .tap-text:active { transform: scale(0.95); }
        
        .hud-label { position: absolute; background: rgba(0,0,0,0.4); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; pointer-events: none; transform: translate(-50%, -100%); margin-top: -10px; display: none; }
        #status-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 2rem; font-weight: 900; display: none; text-shadow: 0 4px 10px black; pointer-events: none; }
    </style>
    <!-- Socket.io Library (Otomatik olarak serverdan gelir ama CDN ekliyoruz garanti olsun) -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
</head>
<body>

    <div id="ui-layer">
        <div id="season-indicator">ðŸŒ¸ YÃœKLENÄ°YOR...</div>
        <div class="score-board">ðŸ¥• <span id="scoreVal">0</span></div>
        <div class="leaderboard"><h4>LÄ°DER TABLOSU</h4><ul id="lbList"></ul></div>
        <div id="status-msg"></div>
        <div class="controls">
            <div id="joystick-area"><div id="joystick-thumb"></div></div>
            <div id="run-btn">KOÅž</div>
        </div>
    </div>

    <div id="menu">
        <h1>BUNNY<br><span>ONLINE</span></h1>
        <input type="text" id="pName" placeholder="Ä°sminiz..." maxlength="12" value="Player">
        <div class="tap-text" onclick="startGame()">ONLINE OYNA</div>
    </div>

    <script>
        // --- Ä°STEMCÄ° AYARLARI ---
        let socket;
        const Game = {
            scene: null, camera: null, renderer: null,
            players: {}, items: [],
            myId: null,
            env: {},
            input: { angle: 0, run: false, active: false },
            lastInputTime: 0
        };

        const CONF = { colors: [0xffffff, 0x333333, 0xffca28, 0xff80ab, 0x40c4ff, 0x8e44ad] };

        function initThree() {
            Game.scene = new THREE.Scene();
            Game.scene.background = new THREE.Color(0x87CEEB);
            
            Game.camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 1, 1000);
            Game.camera.position.set(0, 150, 150);
            Game.camera.lookAt(0,0,0);

            Game.renderer = new THREE.WebGLRenderer({antialias: true});
            Game.renderer.setSize(window.innerWidth, window.innerHeight);
            Game.renderer.shadowMap.enabled = true;
            document.body.appendChild(Game.renderer.domElement);

            const hemi = new THREE.HemisphereLight(0xffffff, 0xffeeb1, 0.8);
            Game.scene.add(hemi);
            const dir = new THREE.DirectionalLight(0xffffff, 0.7);
            dir.position.set(100, 150, 80); dir.castShadow = true;
            dir.shadow.mapSize.width = 2048; dir.shadow.mapSize.height = 2048;
            Game.scene.add(dir);

            createEnvironment();
            animate();
        }

        function createEnvironment() {
            const gGeo = new THREE.CylinderGeometry(800/1.8, 800/1.8, 15, 64);
            Game.env.groundMat = new THREE.MeshStandardMaterial({color: 0xa8e063});
            const ground = new THREE.Mesh(gGeo, Game.env.groundMat);
            ground.position.y = -7.5; ground.receiveShadow = true;
            Game.scene.add(ground);

            const sea = new THREE.Mesh(new THREE.CircleGeometry(2000, 32), new THREE.MeshBasicMaterial({color: 0x4fc3f7}));
            sea.rotation.x = -Math.PI/2; sea.position.y = -8;
            Game.scene.add(sea);
        }

        function startGame() {
            const name = document.getElementById('pName').value;
            document.getElementById('menu').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';

            // SOCKET BAÄžLANTISI BAÅžLAT
            // Not: Render'da otomatik olarak kendi domainine baÄŸlanÄ±r
            try {
                socket = io(); 
                
                socket.on('connect', () => {
                    Game.myId = socket.id;
                    socket.emit('join_game', { name: name, hat: 1 });
                });

                socket.on('state_update', (data) => {
                    updateGameState(data);
                });

                socket.on('season_change', (season) => {
                    updateSeason(season);
                });

                socket.on('player_died', (data) => {
                    if (data.victim === Game.myId) {
                        showStatus("Ã–LDÃœN!");
                        setTimeout(() => location.reload(), 3000);
                    }
                });

            } catch(e) {
                alert("Sunucuya baÄŸlanÄ±lamadÄ±. DosyalarÄ± sunucuya yÃ¼klediÄŸinden emin ol.");
                console.error(e);
            }
        }

        function updateGameState(data) {
            // 1. OyuncularÄ± GÃ¼ncelle
            const serverPlayers = data.players;
            
            // Var olanlarÄ± gÃ¼ncelle veya yenileri ekle
            for (let id in serverPlayers) {
                const pData = serverPlayers[id];
                
                if (!Game.players[id]) {
                    // Yeni oyuncu yarat
                    const mesh = createBunnyMesh(pData.color);
                    Game.players[id] = { mesh: mesh, data: pData, label: createLabel(pData.name) };
                    Game.scene.add(mesh);
                }
                
                // Pozisyon Ä°nterpolasyonu (Basit Lerp)
                const p = Game.players[id];
                p.mesh.position.lerp(new THREE.Vector3(pData.x, 0, pData.z), 0.3);
                p.mesh.rotation.y = pData.angle; // Rotasyon
                
                // Scale gÃ¼ncelle
                const targetScale = pData.scale || 1;
                p.mesh.scale.setScalar(targetScale);

                // UI GÃ¼ncelle
                updateLabelPos(p);
                if (id === Game.myId) {
                    document.getElementById('scoreVal').innerText = Math.floor(pData.score);
                    updateCamera(p.mesh.position, targetScale);
                }
            }

            // Ã‡Ä±kanlarÄ± sil
            for (let id in Game.players) {
                if (!serverPlayers[id]) {
                    Game.scene.remove(Game.players[id].mesh);
                    if(Game.players[id].label) Game.players[id].label.remove();
                    delete Game.players[id];
                }
            }

            // 2. Ä°temleri GÃ¼ncelle
            // Basitlik iÃ§in: Server tÃ¼m itemleri yollar, biz hepsini yeniden Ã§izeriz (Optimize edilebilir)
            // (Performans iÃ§in mevcut itemleri pool yapabilirsin ama ÅŸimdilik silip ekleyelim)
            Game.items.forEach(i => Game.scene.remove(i.mesh));
            Game.items = [];
            
            data.items.forEach(iData => {
                const mesh = createItemMesh(iData.type);
                mesh.position.set(iData.x, 0, iData.z);
                Game.scene.add(mesh);
                Game.items.push({ id: iData.id, mesh: mesh });
            });

            // Liderlik Tablosu
            updateLeaderboard(serverPlayers);
        }

        // --- YARDIMCI FONKSÄ°YONLAR ---
        function createBunnyMesh(color) {
            const group = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({color: color});
            const body = new THREE.Mesh(new THREE.IcosahedronGeometry(1, 1), mat);
            body.position.y = 1; 
            const ear = new THREE.Mesh(new THREE.CapsuleGeometry(0.3, 1.5, 4, 8), mat);
            ear.position.set(0, 2, 0);
            ear.rotation.z = 0.2;
            group.add(body); group.add(ear);
            return group;
        }

        function createItemMesh(type) {
            let col = 0xff9f43;
            if(type==='gold') col=0xffd700;
            if(type==='pepper') col=0xff4757;
            const geo = new THREE.ConeGeometry(0.5, 1.5, 8);
            const mat = new THREE.MeshStandardMaterial({color: col});
            const m = new THREE.Mesh(geo, mat);
            m.rotation.x = Math.PI; m.position.y = 0.75;
            return m;
        }

        function createLabel(name) {
            const div = document.createElement('div');
            div.className = 'hud-label';
            div.innerText = name;
            document.body.appendChild(div);
            return div;
        }

        function updateLabelPos(p) {
            if(!p.label) return;
            const pos = p.mesh.position.clone();
            pos.y += p.mesh.scale.y * 2.5;
            pos.project(Game.camera);
            
            const x = (pos.x * .5 + .5) * window.innerWidth;
            const y = (-(pos.y * .5) + .5) * window.innerHeight;
            
            p.label.style.display = 'block';
            p.label.style.left = x + 'px';
            p.label.style.top = y + 'px';
        }

        function updateCamera(targetPos, zoom) {
            const offset = 40 + (zoom * 2);
            Game.camera.position.lerp(new THREE.Vector3(targetPos.x, offset, targetPos.z + offset), 0.1);
            Game.camera.lookAt(targetPos);
        }

        function updateSeason(s) {
            const names = ["ðŸŒ¸ Ä°LKBAHAR", "â˜€ï¸ YAZ", "ðŸ‚ SONBAHAR", "â„ï¸ KIÅž"];
            const colors = [0xa8e063, 0xe0d68a, 0xd38e45, 0xffffff];
            const skies = [0x87CEEB, 0x00BFFF, 0x708090, 0xddeeff];
            
            document.getElementById('season-indicator').innerText = names[s];
            if(Game.env.groundMat) Game.env.groundMat.color.setHex(colors[s]);
            Game.scene.background.setHex(skies[s]);
        }

        function showStatus(msg) {
            const el = document.getElementById('status-msg');
            el.innerText = msg; el.style.display = 'block';
        }

        function updateLeaderboard(players) {
            const list = Object.values(players).sort((a,b) => b.score - a.score).slice(0, 5);
            const ul = document.getElementById('lbList');
            ul.innerHTML = "";
            list.forEach(p => {
                ul.innerHTML += `<li>${p.name.substring(0,8)}: ${Math.floor(p.score)}</li>`;
            });
        }

        // --- INPUT SÄ°STEMÄ° ---
        function sendInput() {
            if(!socket || !Game.myId) return;
            // Sunucuya sadece aÃ§Ä± ve koÅŸma durumunu yolla
            socket.emit('input', {
                angle: Game.input.angle,
                run: Game.input.run
            });
        }

        const jZone = document.getElementById('joystick-area');
        const handleMove = (cx, cy, x, y) => {
            let dx = x - cx, dy = y - cy;
            Game.input.active = true;
            Game.input.angle = Math.atan2(dy, dx);
            document.getElementById('joystick-thumb').style.transform = `translate(calc(-50% + ${Math.cos(Game.input.angle)*40}px), calc(-50% + ${Math.sin(Game.input.angle)*40}px))`;
        };
        const endTouch = () => { Game.input.active = false; document.getElementById('joystick-thumb').style.transform = `translate(-50%, -50%)`; };
        
        jZone.addEventListener('touchstart', e => { e.preventDefault(); let r=jZone.getBoundingClientRect(); handleMove(r.left+r.width/2, r.top+r.height/2, e.touches[0].clientX, e.touches[0].clientY); });
        jZone.addEventListener('touchmove', e => { e.preventDefault(); let r=jZone.getBoundingClientRect(); handleMove(r.left+r.width/2, r.top+r.height/2, e.touches[0].clientX, e.touches[0].clientY); });
        jZone.addEventListener('touchend', endTouch);
        
        // Mouse desteÄŸi (test iÃ§in)
        jZone.addEventListener('mousedown', e => { let r=jZone.getBoundingClientRect(); handleMove(r.left+r.width/2, r.top+r.height/2, e.clientX, e.clientY); });
        window.addEventListener('mousemove', e => { if(Game.input.active) { let r=jZone.getBoundingClientRect(); handleMove(r.left+r.width/2, r.top+r.height/2, e.clientX, e.clientY); } });
        window.addEventListener('mouseup', endTouch);

        const rBtn = document.getElementById('run-btn');
        rBtn.addEventListener('touchstart', (e)=>{e.preventDefault(); Game.input.run=true;});
        rBtn.addEventListener('touchend', (e)=>{e.preventDefault(); Game.input.run=false;});
        rBtn.addEventListener('mousedown', ()=>{Game.input.run=true;});
        rBtn.addEventListener('mouseup', ()=>{Game.input.run=false;});

        function animate() {
            requestAnimationFrame(animate);
            if(Game.input.active || Game.input.run) sendInput();
            Game.renderer.render(Game.scene, Game.camera);
        }

        window.onload = initThree;

    </script>
</body>
</html>
