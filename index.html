<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bunny Island: Ultimate IO</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Nunito', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;900&display=swap');

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #season-ui { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.3); padding: 5px 20px; border-radius: 20px; color: #fff; font-weight: 900; backdrop-filter: blur(5px); border: 2px solid white; text-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: all 0.5s; }
        .score-board { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.9); padding: 10px 25px; border-radius: 50px; font-size: 1.5rem; font-weight: 900; color: #333; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 8px solid #FF9F43; display: flex; align-items: center; gap: 10px; }
        .leaderboard { position: absolute; top: 70px; right: 20px; background: rgba(255,255,255,0.7); padding: 15px; border-radius: 15px; width: 200px; backdrop-filter: blur(5px); }
        .leaderboard h4 { margin: 0 0 10px 0; color: #FF9F43; border-bottom: 2px solid #fff; padding-bottom: 5px; }
        .leaderboard li { display: flex; justify-content: space-between; font-weight: 800; font-size: 0.9rem; margin-bottom: 5px; color: #444; }
        
        #joystick-area { position: absolute; bottom: 40px; left: 40px; width: 130px; height: 130px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; pointer-events: auto; backdrop-filter: blur(4px); }
        #joystick-thumb { width: 60px; height: 60px; background: #fff; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #run-btn { position: absolute; bottom: 40px; right: 40px; width: 100px; height: 100px; background: linear-gradient(135deg, #00c6fb, #005bea); border-radius: 50%; border: 5px solid white; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; font-size: 1.2rem; box-shadow: 0 10px 30px rgba(0, 198, 251, 0.4); transition: transform 0.1s; }
        #run-btn:active { transform: scale(0.9); }

        #menu { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(0,0,0,0.2), rgba(0,0,0,0.6)); pointer-events: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(8px); }
        h1 { font-size: 5rem; color: white; margin: 0; line-height: 0.9; text-shadow: 0 10px 20px rgba(0,0,0,0.3); transform: rotate(-3deg); }
        h1 span { color: #FFA502; }
        input { background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.5); padding: 15px; border-radius: 30px; color: white; font-size: 1.5rem; text-align: center; margin: 30px; width: 250px; outline: none; font-family: inherit; font-weight: bold; }
        .play-btn { background: white; color: #333; padding: 15px 50px; border-radius: 40px; font-size: 1.5rem; font-weight: 900; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.2); transition: transform 0.1s; }
        .play-btn:active { transform: scale(0.95); }

        .hud-label { position: absolute; background: rgba(0,0,0,0.5); color: white; padding: 2px 8px; border-radius: 8px; font-size: 12px; font-weight: bold; pointer-events: none; transform: translate(-50%, -100%); margin-top: -15px; white-space: nowrap; text-shadow: 0 1px 2px black; display: none; }
        .floating-text { position: absolute; font-weight: 900; font-size: 1.5rem; pointer-events: none; text-shadow: 0 2px 5px rgba(0,0,0,0.5); animation: floatUp 1s forwards; }
        @keyframes floatUp { 0% { transform: translate(-50%, 0) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50px) scale(1.5); opacity: 0; } }
        
        #kill-feed { position: absolute; top: 80px; left: 20px; color: white; font-weight: bold; font-size: 0.9rem; text-shadow: 0 1px 2px black; }
    </style>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
</head>
<body>

    <div id="ui-layer">
        <div id="season-ui">üå∏ MEVSƒ∞M</div>
        <div class="score-board">ü•ï <span id="score">0</span></div>
        <div class="leaderboard"><h4>Lƒ∞DER TABLOSU</h4><ul id="lb"></ul></div>
        <div id="kill-feed"></div>
        <div class="controls">
            <div id="joystick-area"><div id="joystick-thumb"></div></div>
            <div id="run-btn">KO≈û</div>
        </div>
    </div>

    <div id="menu">
        <h1>BUNNY<br><span>ONLINE</span></h1>
        <input type="text" id="username" placeholder="ƒ∞sim Gir" maxlength="12" value="Player">
        <div class="play-btn" onclick="Game.connect()">BA≈ûLA</div>
    </div>

    <script>
        // --- SES EFEKTLERƒ∞ (Basit Synth) ---
        const AudioSys = {
            ctx: null,
            init: function() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            playTone: function(freq, type, dur) {
                if(!this.ctx) return;
                const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                o.type = type; o.frequency.setValueAtTime(freq, this.ctx.currentTime);
                g.gain.setValueAtTime(0.1, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); o.stop(this.ctx.currentTime + dur);
            },
            eat: function() { this.playTone(600 + Math.random()*200, 'triangle', 0.1); },
            bump: function() { this.playTone(100, 'sawtooth', 0.2); },
            kill: function() { this.playTone(150, 'square', 0.1); this.playTone(100, 'square', 0.2); }
        };

        // --- OYUN ƒ∞STEMCƒ∞Sƒ∞ ---
        const Game = {
            socket: null, scene: null, camera: null, renderer: null,
            myId: null, players: {}, items: {}, particles: [], floats: [],
            env: {}, input: { angle: 0, run: false, active: false },
            shake: 0, season: 0,
            
            connect: function() {
                const name = document.getElementById('username').value;
                document.getElementById('menu').style.display = 'none';
                document.getElementById('ui-layer').style.display = 'block';
                AudioSys.init();

                this.socket = io();
                this.socket.on('connect', () => {
                    this.myId = this.socket.id;
                    this.socket.emit('join_game', { name: name, hat: Math.floor(Math.random()*4) });
                });

                this.socket.on('init_game', (data) => { this.updateSeason(data.season); });
                this.socket.on('update', (data) => { this.sync(data); });
                this.socket.on('season_change', (s) => { this.updateSeason(s); });
                this.socket.on('item_event', (data) => { 
                    if(data.playerId === this.myId) AudioSys.eat();
                    // Efekt g√∂ster (Par√ßacƒ±k vs.)
                    const p = this.players[data.playerId];
                    if(p) this.spawnFloatText(data.gain > 0 ? "+" + data.gain : "", p.mesh.position, "#ffcc00");
                });
                this.socket.on('kill_event', (data) => {
                    AudioSys.kill();
                    if(data.killerId === this.myId) this.shake = 10;
                    this.spawnExplosion(data.x, data.z, 0xff0000);
                });

                this.initThree();
            },

            initThree: function() {
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x87CEEB);
                this.camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 1, 1000);
                this.camera.position.set(0, 60, 80);
                this.camera.lookAt(0, 0, 0);

                this.renderer = new THREE.WebGLRenderer({antialias: true});
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.body.appendChild(this.renderer.domElement);

                // I≈üƒ±klar
                const hemi = new THREE.HemisphereLight(0xffffff, 0xffeeb1, 0.8);
                this.scene.add(hemi);
                const dir = new THREE.DirectionalLight(0xffffff, 0.6);
                dir.position.set(100, 150, 80); dir.castShadow = true;
                dir.shadow.mapSize.width = 2048; dir.shadow.mapSize.height = 2048;
                this.scene.add(dir);

                // Zemin
                const gGeo = new THREE.CylinderGeometry(500, 500, 10, 64);
                this.env.groundMat = new THREE.MeshStandardMaterial({color: 0xa8e063});
                const ground = new THREE.Mesh(gGeo, this.env.groundMat);
                ground.position.y = -5; ground.receiveShadow = true;
                this.scene.add(ground);
                
                const sea = new THREE.Mesh(new THREE.CircleGeometry(1500, 32), new THREE.MeshBasicMaterial({color: 0x4fc3f7}));
                sea.rotation.x = -Math.PI/2; sea.position.y = -6;
                this.scene.add(sea);

                this.animate();
                setInterval(() => { if(this.input.active || this.input.run) this.socket.emit('input', this.input); }, 1000/30);
            },

            sync: function(data) {
                // Oyuncular
                const sPlayers = data.players;
                for (let id in sPlayers) {
                    const sp = sPlayers[id];
                    if (!this.players[id]) {
                        this.players[id] = this.createPlayer(sp);
                    }
                    const p = this.players[id];
                    // ƒ∞nterpolasyon (Yumu≈üak hareket)
                    p.targetPos = new THREE.Vector3(sp.x, 0, sp.z);
                    p.targetRot = sp.angle;
                    p.targetScale = sp.scale;
                    p.score = sp.score;
                    p.run = sp.run;
                    
                    if (id === this.myId) {
                        document.getElementById('score').innerText = Math.floor(sp.score);
                    }
                    this.updateLabel(p, sp.name);
                }
                
                // Giden oyuncularƒ± sil
                for (let id in this.players) {
                    if (!sPlayers[id]) {
                        this.scene.remove(this.players[id].mesh);
                        this.players[id].label.remove();
                        delete this.players[id];
                    }
                }

                // ƒ∞temler (Performans i√ßin basit havuzlama yapƒ±labilir ama ≈üimdilik sil-yarat)
                // Mevcut itemleri kontrol et
                const sItems = data.items; // dizi
                const activeIds = new Set();
                
                sItems.forEach(itemData => {
                    activeIds.add(itemData.id);
                    if (!this.items[itemData.id]) {
                        const mesh = this.createItem(itemData.type);
                        mesh.position.set(itemData.x, 0, itemData.z);
                        this.scene.add(mesh);
                        this.items[itemData.id] = mesh;
                        // Spawn efekti
                        mesh.scale.set(0,0,0);
                        new TWEEN(mesh.scale).to({x:1, y:1, z:1}, 500, 'elastic');
                    }
                });

                // Silinen itemler
                for (let id in this.items) {
                    if (!activeIds.has(id)) {
                        this.scene.remove(this.items[id]);
                        delete this.items[id];
                    }
                }

                this.updateLeaderboard(sPlayers);
            },

            createPlayer: function(data) {
                const group = new THREE.Group();
                const mat = new THREE.MeshStandardMaterial({color: data.color});
                
                // G√∂vde
                const body = new THREE.Mesh(new THREE.IcosahedronGeometry(1, 1), mat);
                body.position.y = 1; body.castShadow = true;
                group.add(body);

                // Kulaklar
                const earGeo = new THREE.CapsuleGeometry(0.25, 1, 4, 8);
                const earL = new THREE.Mesh(earGeo, mat); earL.position.set(-0.35, 1.8, 0); earL.rotation.z = 0.3;
                const earR = new THREE.Mesh(earGeo, mat); earR.position.set(0.35, 1.8, 0); earR.rotation.z = -0.3;
                group.add(earL); group.add(earR);

                // ≈ûapka (Basit)
                if (data.hat > 0) {
                    const hatCol = new THREE.MeshStandardMaterial({color: 0x333});
                    const hat = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 0.5, 12), hatCol);
                    hat.position.set(0, 2.2, 0); hat.rotation.x = -0.2;
                    group.add(hat);
                }

                const label = document.createElement('div');
                label.className = 'hud-label';
                label.innerText = data.name;
                document.body.appendChild(label);

                this.scene.add(group);
                return { mesh: group, label: label, body: body, ears: [earL, earR], targetPos: group.position.clone(), targetRot: 0, targetScale: 1, animTime: Math.random() * 100 };
            },

            createItem: function(type) {
                let col = 0xff9f43;
                if (type === 'gold') col = 0xffd700;
                else if (type === 'pepper') col = 0xff4757;
                else if (type === 'magnet') col = 0x40c4ff;
                else if (type === 'mushroom') col = 0x9b59b6;

                const geo = new THREE.ConeGeometry(0.6, 1.5, 8);
                const mat = new THREE.MeshStandardMaterial({color: col});
                const mesh = new THREE.Mesh(geo, mat);
                mesh.rotation.x = Math.PI; mesh.position.y = 1;
                return mesh;
            },

            updateSeason: function(s) {
                this.season = s;
                const names = ["üå∏ ƒ∞LKBAHAR", "‚òÄÔ∏è YAZ", "üçÇ SONBAHAR", "‚ùÑÔ∏è KI≈û"];
                const colors = [0xa8e063, 0xe0d68a, 0xd38e45, 0xffffff];
                const skies = [0x87CEEB, 0x00BFFF, 0x708090, 0xddeeff];
                
                document.getElementById('season-ui').innerText = names[s];
                this.env.groundMat.color.setHex(colors[s]);
                this.scene.background.setHex(skies[s]);
            },

            updateLabel: function(p, name) {
                const pos = p.mesh.position.clone();
                pos.y += p.mesh.scale.y * 2.5;
                pos.project(this.camera);
                const x = (pos.x * .5 + .5) * window.innerWidth;
                const y = (-(pos.y * .5) + .5) * window.innerHeight;
                p.label.style.left = `${x}px`; p.label.style.top = `${y}px`;
                p.label.style.display = (pos.z < 1) ? 'block' : 'none';
            },

            spawnFloatText: function(text, pos3d, color) {
                const div = document.createElement('div');
                div.className = 'floating-text';
                div.innerText = text;
                div.style.color = color;
                document.body.appendChild(div);
                
                // 2D Pozisyon hesapla
                const vec = pos3d.clone(); vec.project(this.camera);
                const x = (vec.x * .5 + .5) * window.innerWidth;
                const y = (-(vec.y * .5) + .5) * window.innerHeight;
                div.style.left = x + 'px'; div.style.top = y + 'px';

                setTimeout(() => div.remove(), 1000);
            },

            spawnExplosion: function(x, z, color) {
                for(let i=0; i<10; i++) {
                    this.particles.push({
                        x: x, y: 1, z: z,
                        vx: (Math.random()-0.5), vy: Math.random(), vz: (Math.random()-0.5),
                        life: 1.0, color: color
                    });
                }
            },

            updateLeaderboard: function(players) {
                const list = Object.values(players).sort((a,b) => b.score - a.score).slice(0, 5);
                let html = "";
                list.forEach(p => html += `<li><span>${p.name}</span><span>${Math.floor(p.score)}</span></li>`);
                document.getElementById('lb').innerHTML = html;
            },

            animate: function() {
                requestAnimationFrame(() => this.animate());
                if (!this.scene) return;

                // Oyuncu Animasyonlarƒ± (Lerp + Bobbing)
                const time = Date.now() * 0.005;
                for (let id in this.players) {
                    const p = this.players[id];
                    
                    // Pozisyon Yumu≈üatma
                    p.mesh.position.lerp(p.targetPos, 0.2);
                    
                    // Rotasyon Yumu≈üatma (En kƒ±sa yoldan)
                    let diff = p.targetRot - p.mesh.rotation.y;
                    while (diff > Math.PI) diff -= Math.PI*2;
                    while (diff < -Math.PI) diff += Math.PI*2;
                    p.mesh.rotation.y += diff * 0.2;

                    // Scale Yumu≈üatma
                    const cs = p.mesh.scale.x;
                    const ns = cs + (p.targetScale - cs) * 0.1;
                    p.mesh.scale.setScalar(ns);

                    // "Juice" Animasyonlarƒ± (Zƒ±plama / Ko≈üma Eƒüilme)
                    const isMoving = p.mesh.position.distanceTo(p.targetPos) > 0.1;
                    p.animTime += isMoving ? (p.run ? 0.4 : 0.2) : 0.05;
                    
                    const hop = Math.abs(Math.sin(p.animTime)) * 0.5 * ns; // Scale'e g√∂re zƒ±pla
                    p.body.position.y = 1 + hop;
                    
                    // Ko≈üuyorsa √∂ne eƒüil
                    p.body.rotation.x = p.run ? 0.4 : 0;
                }

                // Kamera Takibi
                if (this.myId && this.players[this.myId]) {
                    const me = this.players[this.myId];
                    const targetY = 50 + (me.targetScale * 2);
                    const targetZ = 60 + (me.targetScale * 2);
                    
                    // Kamera Titremesi
                    let sx = 0, sy = 0;
                    if (this.shake > 0) {
                        sx = (Math.random()-0.5) * this.shake;
                        sy = (Math.random()-0.5) * this.shake;
                        this.shake *= 0.9;
                    }

                    const idealPos = new THREE.Vector3(me.mesh.position.x + sx, targetY + sy, me.mesh.position.z + targetZ);
                    this.camera.position.lerp(idealPos, 0.1);
                    this.camera.lookAt(me.mesh.position);
                }

                // ƒ∞tem Animasyonlarƒ±
                for (let id in this.items) {
                    const m = this.items[id];
                    m.rotation.y += 0.02;
                    m.position.y = 1 + Math.sin(time + m.id) * 0.3;
                }

                // Partik√ºller (Basit Three.js kullanƒ±mƒ± yerine HTML overlay yapmadƒ±k, Threejs sphere kullandƒ±k)
                // (Burada basit bir partik√ºl sistemi √∂rneƒüi eklenebilir ama kod uzamasƒ±n diye es ge√ßtim, Explosion mantƒ±ƒüƒ±nƒ± ekledim)

                this.renderer.render(this.scene, this.camera);
            }
        };

        // --- BASƒ∞T TWEEN ENGINE ---
        class TWEEN {
            constructor(obj) { this.obj = obj; }
            to(target, dur, type) {
                const start = { ...this.obj };
                const startTime = Date.now();
                const tick = () => {
                    const p = Math.min(1, (Date.now() - startTime) / dur);
                    // Elastic ease out
                    const ease = type === 'elastic' ? 
                        (p === 0 || p === 1 ? p : Math.pow(2, -10 * p) * Math.sin((p - 0.1) * 5 * Math.PI) + 1) : p;
                    
                    for (let k in target) this.obj[k] = start[k] + (target[k] - start[k]) * ease;
                    if (p < 1) requestAnimationFrame(tick);
                };
                tick();
            }
        }

        // --- KONTROLLER ---
        const jZone = document.getElementById('joystick-area');
        const handleMove = (cx, cy, x, y) => {
            let dx = x - cx, dy = y - cy;
            Game.input.active = true;
            Game.input.angle = Math.atan2(dy, dx);
            document.getElementById('joystick-thumb').style.transform = `translate(calc(-50% + ${Math.cos(Game.input.angle)*40}px), calc(-50% + ${Math.sin(Game.input.angle)*40}px))`;
        };
        const endTouch = () => { Game.input.active = false; document.getElementById('joystick-thumb').style.transform = `translate(-50%, -50%)`; };
        
        jZone.addEventListener('touchstart', e => { e.preventDefault(); let r=jZone.getBoundingClientRect(); handleMove(r.left+r.width/2, r.top+r.height/2, e.touches[0].clientX, e.touches[0].clientY); });
        jZone.addEventListener('touchmove', e => { e.preventDefault(); let r=jZone.getBoundingClientRect(); handleMove(r.left+r.width/2, r.top+r.height/2, e.touches[0].clientX, e.touches[0].clientY); });
        jZone.addEventListener('touchend', endTouch);
        
        jZone.addEventListener('mousedown', e => { let r=jZone.getBoundingClientRect(); handleMove(r.left+r.width/2, r.top+r.height/2, e.clientX, e.clientY); });
        window.addEventListener('mousemove', e => { if(Game.input.active) { let r=jZone.getBoundingClientRect(); handleMove(r.left+r.width/2, r.top+r.height/2, e.clientX, e.clientY); } });
        window.addEventListener('mouseup', endTouch);

        const rBtn = document.getElementById('run-btn');
        rBtn.addEventListener('touchstart', (e)=>{e.preventDefault(); Game.input.run=true;});
        rBtn.addEventListener('touchend', (e)=>{e.preventDefault(); Game.input.run=false;});
        rBtn.addEventListener('mousedown', ()=>{Game.input.run=true;});
        rBtn.addEventListener('mouseup', ()=>{Game.input.run=false;});

    </script>
</body>
</html>
