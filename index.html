<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bunny IO Ultimate</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Nunito', sans-serif; user-select: none; touch-action: none; }
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;900&display=swap');

        #ui { position: absolute; top:0; left:0; width:100%; height:100%; display:none; pointer-events:none; }
        .hud { position: absolute; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 8px; transform: translate(-50%, -100%); font-size: 14px; font-weight: 900; white-space: nowrap; pointer-events: none; z-index: 10; transition: top 0.1s; }
        
        #leaderboard { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; padding: 10px; border-radius: 10px; pointer-events: none; }
        
        #joy-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); pointer-events: auto; }
        #joy-stick { width: 50px; height: 50px; background: white; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); }
        
        .btn { position: absolute; width: 70px; height: 70px; border-radius: 50%; border: 4px solid white; display: flex; justify-content: center; align-items: center; font-size: 24px; pointer-events: auto; cursor: pointer; color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn:active { transform: scale(0.9); }
        #btn-run { bottom: 40px; right: 40px; background: #00c6fb; width: 90px; height: 90px; font-weight: bold; font-size: 16px; }
        #btn-shoot { bottom: 150px; right: 30px; background: #ff6b6b; }
        #btn-trap { bottom: 30px; right: 150px; background: #8e44ad; }

        #menu { position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg, #4facfe, #00f2fe); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 99; pointer-events: auto; }
        input { padding: 15px; border-radius: 15px; border: none; text-align: center; margin: 15px; font-size: 18px; width: 200px; }
        .play-btn { padding: 20px 50px; background: #FFA502; border: none; border-radius: 25px; color: white; font-size: 24px; font-weight: 900; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .hats { display: flex; gap: 10px; margin: 20px; }
        .hat { font-size: 30px; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 10px; cursor: pointer; border: 3px solid transparent; }
        .hat.sel { border-color: #FFA502; background: white; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
</head>
<body>

    <div id="ui">
        <div id="leaderboard"><h3>Liderler</h3><div id="lb-content"></div></div>
        <div id="joy-zone"><div id="joy-stick"></div></div>
        <div id="btn-run" class="btn">KO≈û</div>
        <div id="btn-shoot" class="btn">üöÄ</div>
        <div id="btn-trap" class="btn">üçÑ</div>
    </div>

    <div id="menu">
        <h1 style="color:white; font-size: 4rem; margin:0;">BUNNY IO</h1>
        <input type="text" id="pName" value="Oyuncu" maxlength="10">
        <div class="hats">
            <div class="hat sel" onclick="sHat(0,this)">‚ùå</div>
            <div class="hat" onclick="sHat(1,this)">üé™</div>
            <div class="hat" onclick="sHat(2,this)">üé©</div>
            <div class="hat" onclick="sHat(3,this)">ü™ñ</div>
        </div>
        <button class="play-btn" onclick="join()">BAƒûLAN</button>
    </div>

    <script>
        let socket, scene, camera, renderer, myId;
        let players = {}, items = {}, projs = [], traps = [];
        let input = { active: false, angle: 0, run: false };
        let selHat = 0;

        function sHat(id, el) { 
            selHat = id; 
            document.querySelectorAll('.hat').forEach(e => e.classList.remove('sel')); 
            el.classList.add('sel'); 
        }

        function join() {
            const name = document.getElementById('pName').value || "Oyuncu";
            socket = io();
            socket.on('connect', () => socket.emit('joinGame', { name: name, hat: selHat }));
            socket.on('initGame', (d) => {
                myId = d.id;
                document.getElementById('menu').style.display = 'none';
                document.getElementById('ui').style.display = 'block';
                init3D();
            });
            socket.on('state', draw);
        }

        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(0, 50, 60);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            const h = new THREE.HemisphereLight(0xffffff, 0xffeeb1, 0.8); scene.add(h);
            const d = new THREE.DirectionalLight(0xffffff, 0.8); d.position.set(50, 100, 50); d.castShadow = true; scene.add(d);

            // Zemin
            const g = new THREE.Mesh(new THREE.CylinderGeometry(160, 160, 5, 64), new THREE.MeshStandardMaterial({ color: 0xa8e063 }));
            g.position.y = -2.5; g.receiveShadow = true; scene.add(g);
            const s = new THREE.Mesh(new THREE.CircleGeometry(500, 32), new THREE.MeshBasicMaterial({ color: 0x4fc3f7 }));
            s.rotation.x = -Math.PI / 2; s.position.y = -5; scene.add(s);

            createDecor();
            animate();
        }

        function createDecor() {
            for(let i=0; i<30; i++) {
                const x = (Math.random()-0.5)*250, z = (Math.random()-0.5)*250;
                if(Math.hypot(x,z) > 140) continue;
                const m = new THREE.Mesh(new THREE.DodecahedronGeometry(Math.random()*2+1), new THREE.MeshStandardMaterial({color:0x8d6e63}));
                m.position.set(x, 1, z); scene.add(m);
            }
        }

        function draw(data) {
            let serverIds = new Set();
            let lb = [];

            // Oyuncular
            data.players.forEach(p => {
                serverIds.add(p.id);
                lb.push(p);

                if (!players[p.id]) createPlayer(p);

                let pl = players[p.id];
                pl.mesh.position.lerp(new THREE.Vector3(p.x, 0, p.z), 0.3);
                
                // Rotasyon (Yumu≈üak)
                pl.mesh.rotation.y = p.angle;

                // Animasyon (Zƒ±plama)
                const time = Date.now() * 0.015;
                const bounce = p.isMoving ? Math.abs(Math.sin(time))*1.5 : Math.abs(Math.sin(time*0.5))*0.3;
                pl.mesh.position.y = bounce;

                // Efektler (Hayalet Modu vs.)
                if(p.effects && p.effects.ghost) {
                    pl.body.material.opacity = 0.4;
                    pl.body.material.transparent = true;
                } else {
                    pl.body.material.opacity = 1.0;
                    pl.body.material.transparent = false;
                }

                // B√ºy√ºme
                let scale = 1 + (p.score * 0.01);
                pl.mesh.scale.setScalar(scale);
                updateHud(pl, scale, p.id === myId);

                if (p.id === myId) {
                    camera.position.lerp(new THREE.Vector3(p.x, 30 + (scale * 10), p.z + 40 + (scale * 10)), 0.1);
                    camera.lookAt(p.x, 0, p.z);
                }
            });

            for (let id in players) {
                if (!serverIds.has(id)) { scene.remove(players[id].mesh); players[id].hud.remove(); delete players[id]; }
            }

            // Liderlik
            lb.sort((a,b)=>b.score-a.score);
            document.getElementById('lb-content').innerHTML = lb.slice(0,5).map((p,i)=>
                `<div style="color:${p.id===myId?'#FFA502':'white'}">#${i+1} ${p.name.substring(0,8)} - ${Math.floor(p.score)}</div>`
            ).join('');

            // E≈üyalar (RENKLER GERƒ∞ GELDƒ∞)
            for (let id in items) scene.remove(items[id]); items = {};
            data.items.forEach(c => {
                let col = 0xff9f43; // Havu√ß
                if(c.type==='gold') col=0xFFD700; // √ñl√ºms√ºzl√ºk
                if(c.type==='pepper') col=0xff4757; // Hƒ±z
                if(c.type==='magnet') col=0x2ed573; // Mƒ±knatƒ±s (Ye≈üil)
                if(c.type==='mushroom') col=0x8e44ad; // Mantar (Mor)

                let geo = c.type==='carrot' ? new THREE.ConeGeometry(0.5, 1.5, 8) : new THREE.BoxGeometry(0.8,0.8,0.8);
                if(c.type==='mushroom') geo = new THREE.DodecahedronGeometry(0.6);

                let m = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ color: col }));
                m.position.set(c.x, 1, c.z); 
                if(c.type==='carrot') m.rotation.x = Math.PI;
                scene.add(m); items[c.id] = m;
            });

            // Mermiler ve Tuzaklar
            projs.forEach(p => scene.remove(p)); projs = [];
            data.projectiles.forEach(p => {
                let m = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshStandardMaterial({ color: 0xff4757 }));
                m.position.set(p.x, 1, p.z); scene.add(m); projs.push(m);
            });
            traps.forEach(t => scene.remove(t)); traps = [];
            data.traps.forEach(t => {
                let m = new THREE.Mesh(new THREE.DodecahedronGeometry(0.6), new THREE.MeshStandardMaterial({ color: 0x8e44ad }));
                m.position.set(t.x, 0.6, t.z); scene.add(m); traps.push(m);
            });
        }

        function createPlayer(d) {
            const g = new THREE.Group();
            const b = new THREE.Mesh(new THREE.IcosahedronGeometry(1, 1), new THREE.MeshStandardMaterial({ color: d.color }));
            b.position.y = 1; b.castShadow = true; g.add(b);
            
            const eGeo = new THREE.CapsuleGeometry(0.2, 0.8, 4, 8);
            const el = new THREE.Mesh(eGeo, new THREE.MeshStandardMaterial({ color: d.color })); el.position.set(-0.3, 1.8, 0); el.rotation.z = 0.3; g.add(el);
            const er = new THREE.Mesh(eGeo, new THREE.MeshStandardMaterial({ color: d.color })); er.position.set(0.3, 1.8, 0); er.rotation.z = -0.3; g.add(er);
            const t = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshStandardMaterial({color:0xffffff})); t.position.set(0, 0.5, -0.9); g.add(t);

            if (d.hat == 1) { const h = new THREE.Mesh(new THREE.ConeGeometry(0.3, 0.8, 16), new THREE.MeshStandardMaterial({ color: 0xff4757 })); h.position.y = 2.2; g.add(h); }
            if (d.hat == 2) { const h = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 0.6, 16), new THREE.MeshStandardMaterial({ color: 0x333333 })); h.position.y = 2.2; g.add(h); }
            if (d.hat == 3) { const h = new THREE.Mesh(new THREE.SphereGeometry(0.5, 16, 16, 0, 6.3, 0, 1.5), new THREE.MeshStandardMaterial({ color: 0xbdc3c7 })); h.position.y = 2.2; g.add(h); }

            scene.add(g);
            const hud = document.createElement('div'); hud.className = 'hud'; hud.innerText = d.name; document.body.appendChild(hud);
            players[d.id] = { mesh: g, hud: hud, body: b }; // Body referansƒ± (≈üeffaflƒ±k i√ßin)
        }

        function updateHud(pl, scale, isMe) {
            let pos = pl.mesh.position.clone();
            pos.y += 2.5 + (scale * 0.8);
            pos.project(camera);
            if (Math.abs(pos.z) > 1) { pl.hud.style.display = 'none'; return; }
            pl.hud.style.display = 'block';
            pl.hud.style.left = (pos.x * .5 + .5) * window.innerWidth + 'px';
            pl.hud.style.top = (-(pos.y * .5) + .5) * window.innerHeight + 'px';
            pl.hud.style.zIndex = isMe ? 100 : 10;
        }

        function animate() {
            requestAnimationFrame(animate);
            if (socket && myId) socket.emit('input', input);
            if (renderer && scene && camera) renderer.render(scene, camera);
        }

        const joy = document.getElementById('joy-zone');
        const thumb = document.getElementById('joy-stick');
        const moveJoy = (cx, cy, x, y) => {
            let dx = x - cx, dy = y - cy, dist = Math.min(Math.hypot(dx, dy), 40), ang = Math.atan2(dy, dx);
            input.active = true; input.angle = Math.atan2(dx, dy);
            thumb.style.transform = `translate(calc(-50% + ${Math.cos(ang) * dist}px), calc(-50% + ${Math.sin(ang) * dist}px))`;
        };
        joy.addEventListener('touchmove', e => { e.preventDefault(); let r = joy.getBoundingClientRect(); moveJoy(r.left + r.width / 2, r.top + r.height / 2, e.touches[0].clientX, e.touches[0].clientY); });
        joy.addEventListener('touchend', () => { input.active = false; thumb.style.transform = 'translate(-50%,-50%)'; });
        
        let drag = false;
        joy.addEventListener('mousedown', () => drag = true);
        window.addEventListener('mouseup', () => { drag = false; input.active = false; thumb.style.transform = 'translate(-50%,-50%)'; });
        window.addEventListener('mousemove', e => { if (drag) { let r = joy.getBoundingClientRect(); moveJoy(r.left + r.width / 2, r.top + r.height / 2, e.clientX, e.clientY); } });

        const bind = (id, fnS, fnE) => {
            let el = document.getElementById(id);
            el.addEventListener('touchstart', e => { e.preventDefault(); fnS() });
            if (fnE) el.addEventListener('touchend', e => { e.preventDefault(); fnE() });
            el.addEventListener('mousedown', fnS);
            if (fnE) el.addEventListener('mouseup', fnE);
        };
        bind('btn-run', () => input.run = true, () => input.run = false);
        bind('btn-shoot', () => socket.emit('shoot'));
        bind('btn-trap', () => socket.emit('trap'));

        window.addEventListener('resize', () => { if(camera) { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }});
    </script>
</body>
</html>
