<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bunny Island: Speedster</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Nunito', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; touch-action: none; }
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;900&display=swap');

        /* UI */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        
        .score-board {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.9); padding: 5px 20px; border-radius: 30px;
            border-left: 6px solid #FF9F43; color: #333; font-weight: 900; font-size: 1.4rem;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .leaderboard {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 12px;
            width: 150px; pointer-events: none;
        }
        .leaderboard h4 { margin: 0 0 5px 0; color: #FF9F43; font-size: 0.8rem; border-bottom: 2px solid #ddd; }
        .leaderboard ul { list-style: none; padding: 0; margin: 0; font-size: 0.75rem; font-weight: 800; }
        .leaderboard li { display: flex; justify-content: space-between; margin-bottom: 3px; }

        /* KONTROLLER */
        #joystick-area {
            position: absolute; bottom: 40px; left: 40px;
            width: 120px; height: 120px; background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 50%;
            pointer-events: auto; backdrop-filter: blur(2px); touch-action: none;
        }
        #joystick-thumb {
            width: 50px; height: 50px; background: #fff; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); pointer-events: none;
        }

        .action-container { position: absolute; bottom: 30px; right: 30px; width: 150px; height: 150px; pointer-events: none; }
        .action-btn {
            position: absolute; width: 60px; height: 60px; border-radius: 50%;
            border: 3px solid #fff; display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1.4rem; color: white; cursor: pointer; pointer-events: auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #trap-btn { background: #8e44ad; bottom: 0; left: 0; }
        #shoot-btn { background: #ff6b6b; top: 0; right: 0; }
        #run-btn {
            position: absolute; bottom: 20px; right: 20px;
            width: 80px; height: 80px; background: linear-gradient(135deg, #00c6fb, #005bea);
            border-radius: 50%; border: 4px solid white; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 900; pointer-events: auto;
        }

        /* MEN√ú */
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto; z-index: 99; text-align: center;
        }
        .main-btn { padding: 15px; border: none; border-radius: 15px; font-weight: 900; font-size: 1.2rem; cursor: pointer; background: white; color: #00c6fb; width: 200px; margin-top: 10px; }
        .main-btn.play { background: #FFA502; color: white; font-size: 1.5rem; }
        
        .hud-label { position: absolute; background: rgba(0,0,0,0.5); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; transform: translate(-50%, -100%); pointer-events: none; }
        .hud-label.me { color: #FFA502; border: 1px solid #FFA502; background: rgba(0,0,0,0.8); z-index: 10; }
        .hidden { display: none !important; }

        /* YATAY EKRAN */
        @media screen and (orientation: landscape) {
            .action-container { width: 200px; height: 140px; right: 10px; bottom: 10px; }
            #run-btn { right: 10px; bottom: 10px; width: 70px; height: 70px; }
            #joystick-area { bottom: 20px; left: 20px; width: 100px; height: 100px; }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div id="ui-layer">
        <div class="score-board">ü•ï <span id="scoreVal">0</span></div>
        <div class="leaderboard"><h4>TOP 5</h4><ul id="lbList"></ul></div>
        <div class="controls">
            <div id="joystick-area"><div id="joystick-thumb"></div></div>
            <div class="action-container">
                <div id="trap-btn" class="action-btn">üçÑ</div>
                <div id="shoot-btn" class="action-btn">üöÄ</div>
            </div>
            <div id="run-btn">KO≈û</div>
        </div>
    </div>

    <div id="menu" class="overlay-screen">
        <h1 style="color:white; font-size:3rem; margin:0;">BUNNY.IO</h1>
        <p style="color:#e0f7fa;">Online Sava≈ü</p>
        <input type="text" id="pName" placeholder="ƒ∞sim Gir" maxlength="12" style="padding:15px; border-radius:15px; border:none; text-align:center; font-size:1.2rem; margin:20px;">
        <button class="main-btn play" onclick="Game.connect()">OYNA</button>
    </div>

    <div id="game-over" class="overlay-screen hidden" style="background: rgba(0,0,0,0.9);">
        <h1 style="color:#FF6B6B;">OYUN Bƒ∞TTƒ∞</h1>
        <p id="death-msg" style="color:white;">Yendin...</p>
        <button class="main-btn" onclick="location.reload()">TEKRAR</button>
    </div>

    <script>
        const Game = {
            socket: null, scene: null, camera: null, renderer: null,
            player: null, entities: {}, items: {}, 
            input: { x:0, y:0, active:false, angle:0, run:false },
            
            connect: function() {
                const pName = document.getElementById('pName').value || "Oyuncu";
                document.getElementById('menu').classList.add('hidden');
                document.getElementById('ui-layer').style.display = 'block';
                
                this.initThree();
                this.socket = io();

                this.socket.on('connect', () => {
                    this.socket.emit('joinGame', { name: pName, hat: 0 });
                });

                this.socket.on('initGame', (data) => {
                    this.myId = data.myId;
                    Object.values(data.players).forEach(p => this.updateEntity(p));
                    data.items.forEach(i => this.spawnItem(i));
                });

                this.socket.on('newPlayer', p => this.updateEntity(p));
                this.socket.on('stateUpdate', players => {
                    Object.values(players).forEach(p => this.updateEntity(p));
                    this.checkCollisions();
                    this.updateUI();
                });
                this.socket.on('playerDisconnected', id => this.removeEntity(id));
                this.socket.on('itemSpawned', item => this.spawnItem(item));
                this.socket.on('itemRemoved', data => { this.removeItem(data.itemId); });
                this.socket.on('youDied', data => {
                    document.getElementById('ui-layer').style.display = 'none';
                    document.getElementById('game-over').classList.remove('hidden');
                    document.getElementById('death-msg').innerText = `${data.killerName} seni yedi!`;
                    this.socket.disconnect();
                });
                this.socket.on('playerKilled', data => { this.removeEntity(data.victimId); });

                this.animate();
            },

            initThree: function() {
                this.scene = new THREE.Scene(); 
                this.scene.background = new THREE.Color(0x87CEEB);
                this.camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 1, 500); // Draw distance d√º≈ü√ºr√ºld√º
                this.camera.position.set(0, 40, 60);
                
                // PERFORMANS AYARLARI
                this.renderer = new THREE.WebGLRenderer({antialias:false, powerPreference: "high-performance"}); // Antialias kapalƒ±
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(1); // Piksel oranƒ± 1 (Mobil kasma √ß√∂z√ºm√º)
                // G√∂lgeler tamamen kapatƒ±ldƒ±
                document.body.appendChild(this.renderer.domElement);

                // I≈üƒ±klandƒ±rma (Basitle≈ütirildi)
                const hemi = new THREE.HemisphereLight(0xffffff, 0xffeeb1, 1);
                this.scene.add(hemi);
                const dir = new THREE.DirectionalLight(0xffffff, 0.5);
                dir.position.set(50, 100, 50);
                this.scene.add(dir);

                // Zemin (Segment sayƒ±sƒ± d√º≈ü√ºr√ºld√º)
                const ground = new THREE.Mesh(new THREE.CylinderGeometry(400, 400, 5, 16), new THREE.MeshStandardMaterial({color: 0xa8e063}));
                ground.position.y = -2.5; this.scene.add(ground);
                const sea = new THREE.Mesh(new THREE.CircleGeometry(600, 16), new THREE.MeshBasicMaterial({color: 0x4fc3f7}));
                sea.rotation.x = -Math.PI/2; sea.position.y = -3; this.scene.add(sea);
                
                // Dekor (Azaltƒ±ldƒ± ve basitle≈ütirildi)
                const trunkGeo = new THREE.CylinderGeometry(0.5,0.7,2,5); // 5gen aƒüa√ßlar
                const topGeo = new THREE.DodecahedronGeometry(2);
                const matTrunk = new THREE.MeshStandardMaterial({color:0x8d6e63});
                const matTop = new THREE.MeshStandardMaterial({color:0x2ecc71});

                for(let i=0; i<30; i++) { // Aƒüa√ß sayƒ±sƒ± 30'a d√º≈üt√º
                    const tree = new THREE.Group();
                    const trunk = new THREE.Mesh(trunkGeo, matTrunk); trunk.position.y=1;
                    const top = new THREE.Mesh(topGeo, matTop); top.position.y=3.5;
                    tree.add(trunk); tree.add(top);
                    const ang = Math.random()*6.28, r = 50 + Math.random()*300;
                    tree.position.set(Math.cos(ang)*r, 0, Math.sin(ang)*r);
                    this.scene.add(tree);
                }
            },

            updateEntity: function(data) {
                let entity = this.entities[data.id];
                if (!entity) {
                    const group = new THREE.Group();
                    // Karakter detaylarƒ± d√º≈ü√ºr√ºld√º
                    const bodyMat = new THREE.MeshStandardMaterial({color: data.color});
                    const body = new THREE.Mesh(new THREE.IcosahedronGeometry(1, 1), bodyMat); // D√º≈ü√ºk detay
                    body.position.y = 0.9; group.add(body);

                    const ear = new THREE.Mesh(new THREE.BoxGeometry(0.3, 1.5, 0.3), bodyMat); // Kulaklar kutu oldu
                    ear.position.set(-0.4, 1.5, 0); group.add(ear);
                    const ear2 = ear.clone(); ear2.position.set(0.4, 1.5, 0); group.add(ear2);

                    const label = document.createElement('div');
                    label.className = `hud-label ${data.id === this.myId ? 'me' : ''}`;
                    label.innerText = data.name;
                    document.body.appendChild(label);

                    entity = { mesh: group, label: label, data: data, targetX: data.x, targetZ: data.z, targetAngle: data.angle };
                    this.scene.add(group);
                    this.entities[data.id] = entity;
                    if (data.id === this.myId) this.player = entity;
                }
                entity.targetX = data.x; entity.targetZ = data.z; entity.targetAngle = data.angle;
                entity.data.score = data.score; entity.data.isMoving = data.isMoving;
                const scale = 1 + (data.score * 0.008);
                entity.mesh.scale.setScalar(Math.min(scale, 20));
            },

            removeEntity: function(id) {
                if(this.entities[id]) {
                    this.scene.remove(this.entities[id].mesh);
                    if(this.entities[id].label) this.entities[id].label.remove();
                    delete this.entities[id];
                }
            },

            spawnItem: function(data) {
                // Havu√ßlar √ßok basit koni oldu
                const mesh = new THREE.Mesh(new THREE.ConeGeometry(0.5, 1.5, 5), new THREE.MeshStandardMaterial({color:0xff9f43}));
                mesh.position.set(data.x, 0.75, data.z); mesh.rotation.x=Math.PI;
                this.scene.add(mesh);
                this.items[data.id] = { mesh: mesh, data: data };
            },

            removeItem: function(id) {
                if(this.items[id]) { this.scene.remove(this.items[id].mesh); delete this.items[id]; }
            },

            animate: function() {
                requestAnimationFrame(() => this.animate());
                if(!this.player) return;

                let move = false; const speed = 0.5;
                if(this.input.active) {
                    move = true;
                    this.player.targetAngle = -this.input.angle + Math.PI/2;
                    this.player.targetX += Math.sin(this.player.targetAngle) * speed;
                    this.player.targetZ += Math.cos(this.player.targetAngle) * speed;
                }
                
                this.socket.emit('playerMove', { x: this.player.targetX, z: this.player.targetZ, angle: this.player.targetAngle, isMoving: move });

                Object.values(this.entities).forEach(e => {
                    e.mesh.position.x += (e.targetX - e.mesh.position.x) * 0.2;
                    e.mesh.position.z += (e.targetZ - e.mesh.position.z) * 0.2;
                    let diff = e.targetAngle - e.mesh.rotation.y;
                    while(diff > Math.PI) diff -= Math.PI*2; while(diff < -Math.PI) diff += Math.PI*2;
                    e.mesh.rotation.y += diff * 0.2;

                    if(e.data.isMoving) e.mesh.position.y = Math.abs(Math.sin(Date.now() * 0.015)) * 0.5; 
                    else e.mesh.position.y = 0;

                    const pos = e.mesh.position.clone(); pos.y += 3 * e.mesh.scale.y; pos.project(this.camera);
                    const x = (pos.x * .5 + .5) * window.innerWidth; const y = (-(pos.y * .5) + .5) * window.innerHeight;
                    e.label.style.left = x + 'px'; e.label.style.top = y + 'px';
                });

                Object.values(this.items).forEach(i => { i.mesh.rotation.y += 0.05; });

                this.camera.position.x += (this.player.mesh.position.x - this.camera.position.x) * 0.1;
                this.camera.position.z += ((this.player.mesh.position.z + 50 + this.player.mesh.scale.x*2) - this.camera.position.z) * 0.1;
                this.camera.lookAt(this.player.mesh.position);

                this.renderer.render(this.scene, this.camera);
            },

            checkCollisions: function() {
                if(!this.player) return;
                const px = this.player.mesh.position.x; const pz = this.player.mesh.position.z; const size = this.player.mesh.scale.x;

                for(const id in this.items) {
                    const item = this.items[id];
                    const dist = Math.hypot(px - item.data.x, pz - item.data.z);
                    if(dist < size + 1.5) {
                        this.socket.emit('requestEatItem', parseInt(id)); delete this.items[id]; this.scene.remove(item.mesh);
                    }
                }
                for(const id in this.entities) {
                    if(id === this.myId) continue;
                    const enemy = this.entities[id];
                    const dist = Math.hypot(px - enemy.mesh.position.x, pz - enemy.mesh.position.z);
                    if(dist < size && this.player.data.score > enemy.data.score * 1.2) {
                        this.socket.emit('killPlayer', id); this.removeEntity(id);
                    }
                }
            },

            updateUI: function() {
                if(this.player) document.getElementById('scoreVal').innerText = this.player.data.score;
                const list = Object.values(this.entities).sort((a,b) => b.data.score - a.data.score).slice(0,5);
                document.getElementById('lbList').innerHTML = list.map(e => `<li><span>${e.data.name}</span><span>${e.data.score}</span></li>`).join('');
            }
        };

        // KONTROLLER (PC & MOBƒ∞L D√úZELTƒ∞LDƒ∞)
        const jZone = document.getElementById('joystick-area'); 
        const jThumb = document.getElementById('joystick-thumb');
        let jRect;

        const handleMove = (cx, cy, x, y) => { 
            let dx = x - cx, dy = y - cy; 
            let dist = Math.min(Math.hypot(dx,dy), 50); 
            Game.input.active = true; 
            Game.input.angle = Math.atan2(dy, dx); 
            jThumb.style.transform = `translate(calc(-50% + ${Math.cos(Game.input.angle)*dist}px), calc(-50% + ${Math.sin(Game.input.angle)*dist}px))`; 
        };

        const startInput = (x, y) => {
            jRect = jZone.getBoundingClientRect();
            handleMove(jRect.left + jRect.width/2, jRect.top + jRect.height/2, x, y);
        };

        // Dokunmatik
        jZone.addEventListener('touchstart', (e) => { e.preventDefault(); startInput(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
        jZone.addEventListener('touchmove', (e) => { e.preventDefault(); if(Game.input.active) startInput(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
        jZone.addEventListener('touchend', () => { Game.input.active = false; jThumb.style.transform = `translate(-50%, -50%)`; });

        // Mouse (PC ƒ∞√ßin Kesin √á√∂z√ºm)
        let isMouseDown = false;
        jZone.addEventListener('mousedown', (e) => { 
            isMouseDown = true; 
            startInput(e.clientX, e.clientY); 
        });
        window.addEventListener('mousemove', (e) => { 
            if(isMouseDown) startInput(e.clientX, e.clientY); 
        });
        window.addEventListener('mouseup', () => { 
            isMouseDown = false; 
            Game.input.active = false; 
            jThumb.style.transform = `translate(-50%, -50%)`; 
        });

        // Butonlar
        const bindBtn = (id, actionKey) => {
            const btn = document.getElementById(id);
            const activate = (e) => { e.preventDefault(); if(Game.player) Game.player[actionKey] && Game.player[actionKey](); };
            btn.addEventListener('touchstart', activate, {passive:false});
            btn.addEventListener('mousedown', activate);
        };
        // ≈ûimdilik sadece efekt olarak, sunucu tarafƒ± kodlanmalƒ±
        document.getElementById('run-btn').addEventListener('touchstart', (e)=>{e.preventDefault(); Game.input.run=true;});
        document.getElementById('run-btn').addEventListener('touchend', (e)=>{e.preventDefault(); Game.input.run=false;});
        
        window.addEventListener('resize', () => { if(Game.renderer) { Game.camera.aspect = window.innerWidth/window.innerHeight; Game.camera.updateProjectionMatrix(); Game.renderer.setSize(window.innerWidth, window.innerHeight); }});
    </script>
</body>
</html>
